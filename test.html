<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Viscous Fluid Prototype</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
            font-family: sans-serif;
        }

        /* 【重要】メタボールの閾値を調整 */
        /* blurを少し強くし、contrastを調整して「とろみ」を出します */
        canvas {
            display: block;
            filter: blur(10px) contrast(30);
            background-color: #000;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
            color: white;
            z-index: 10;
        }

        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
        }

        button {
            padding: 20px 40px;
            font-size: 24px;
            background: #ff0055;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
        }

        #score {
            font-size: 24px;
            color: #ff0055;
            font-weight: bold;
            text-shadow: 0 0 5px red;
        }

        .bar-container {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
        }

        #charge-bar {
            width: 0%;
            height: 100%;
            background: white;
            transition: width 0.1s;
        }

        /* ターゲット（子宮口） */
        #target-zone {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border: 4px solid #440022;
            border-radius: 50%;
            background: radial-gradient(circle, transparent 40%, #440022 100%);
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <div id="target-zone"></div>
    <div id="ui-layer">
        <div style="text-align:center;">
            <div id="score">INSIDE: 0</div>
            <div id="status" style="font-size:12px; opacity:0.6;">High Viscosity Mode</div>
        </div>
        <div style="margin-bottom: 50px;">
            <div class="bar-container">
                <div id="charge-bar"></div>
            </div>
        </div>
    </div>

    <div id="start-screen">
        <h1 style="color:white; margin-bottom:20px;">Sticky Fluid</h1>
        <p style="color:#aaa; margin-bottom:30px;">振って溜めて、離して発射</p>
        <button id="btn-start">START</button>
    </div>

    <script>
        // --- 物理パラメータ調整（ここがいやらしさの数値） ---
        const FLUID_FRICTION = 0.5;      // 壁への引っかかり具合 (0~1)
        const FLUID_AIR_FRICTION = 0.05; // 空気のネバネバ具合 (高いほどねっとり動く)
        const FLUID_RESTITUTION = 0.0;   // 跳ね返り (0だとベチャッと張り付く)
        const FLUID_DENSITY = 0.05;      // 重さ

        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner,
            Bodies = Matter.Bodies, Composite = Matter.Composite, Mouse = Matter.Mouse,
            MouseConstraint = Matter.MouseConstraint, Events = Matter.Events;

        const engine = Engine.create();
        const world = engine.world;
        const width = window.innerWidth;
        const height = window.innerHeight;

        // レンダラー設定
        const render = Render.create({
            element: document.body, engine: engine,
            options: {
                width: width, height: height,
                wireframes: false, background: 'transparent',
                pixelRatio: window.devicePixelRatio
            }
        });

        // 壁の作成（少し摩擦を上げて液体をキャッチしやすくする）
        const wallOpt = {
            isStatic: true,
            render: { fillStyle: '#222' },
            friction: 1.0 // 壁はザラザラにして引っ掛ける
        };

        // 子宮のような狭い通路を作る
        const walls = [
            Bodies.rectangle(width / 2, height + 60, width, 100, wallOpt), // 床
            Bodies.rectangle(0, height / 2, 40, height, wallOpt), // 左壁
            Bodies.rectangle(width, height / 2, 40, height, wallOpt), // 右壁
            // 障害物（くびれ）
            Bodies.circle(width * 0.1, height * 0.3, 80, wallOpt),
            Bodies.circle(width * 0.9, height * 0.3, 80, wallOpt)
        ];
        Composite.add(world, walls);

        // ゲーム変数
        let pleasure = 0;
        let particleCount = 0;
        let lastAcc = { x: 0, y: 0, z: 0 };

        // スタート処理
        const btnStart = document.getElementById('btn-start');
        btnStart.addEventListener('click', async () => {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                try { await DeviceMotionEvent.requestPermission(); } catch (e) { }
            }
            window.addEventListener('devicemotion', handleMotion);
            document.getElementById('start-screen').style.display = 'none';
            Render.run(render);
            Runner.run(Runner.create(), engine);
        });

        // センサー処理
        function handleMotion(e) {
            const acc = e.accelerationIncludingGravity;
            if (!acc) return;

            const dx = Math.abs(acc.x - lastAcc.x);
            const dy = Math.abs(acc.y - lastAcc.y);
            const dz = Math.abs(acc.z - lastAcc.z);

            // シェイク検知
            if (dy + dz > 15) {
                pleasure += 2.5;
                if (pleasure > 100) pleasure = 100;
                document.getElementById('charge-bar').style.width = pleasure + '%';
            }

            // 重力操作（スマホの傾きに合わせてねっとり流れる）
            engine.gravity.x = acc.x * 0.15;
            engine.gravity.y = -acc.y * 0.15;

            lastAcc = { x: acc.x, y: acc.y, z: acc.z };
        }

        // 発射処理（タップ離した時）
        let isTouching = false;
        document.body.addEventListener('touchstart', () => isTouching = true);
        document.body.addEventListener('touchend', () => {
            if (isTouching) fireFluid();
            isTouching = false;
        });
        document.body.addEventListener('mousedown', () => { pleasure += 30; fireFluid(); }); // PCデバッグ用

        function fireFluid() {
            if (pleasure < 5) return;

            const amount = Math.floor(pleasure / 1.5); // 量を少し増やす
            const startX = width / 2;
            const startY = height - 50;

            for (let i = 0; i < amount; i++) {
                // 粒子のサイズをランダムにして「ダマ」感を出す
                const radius = 5 + Math.random() * 8;

                const fluid = Bodies.circle(
                    startX + (Math.random() - 0.5) * 30,
                    startY + (Math.random() - 0.5) * 30,
                    radius,
                    {
                        render: { fillStyle: '#fff' }, // 白濁液
                        friction: FLUID_FRICTION,         // 摩擦マシマシ
                        frictionAir: FLUID_AIR_FRICTION,  // 空気抵抗マシマシ（ねっとり感の正体）
                        restitution: FLUID_RESTITUTION,   // 跳ね返りなし
                        density: FLUID_DENSITY            // 重くする
                    }
                );

                // 発射力（重いので少し強めに飛ばす）
                const forceX = (Math.random() - 0.5) * 0.08;
                const forceY = -0.15 - (Math.random() * 0.2); // 勢いよく

                Matter.Body.applyForce(fluid, fluid.position, { x: forceX, y: forceY });
                Composite.add(world, fluid);
                particleCount++;
            }

            document.getElementById('score').innerText = "INSIDE: " + particleCount;
            pleasure = 0;
            document.getElementById('charge-bar').style.width = '0%';
        }
    </script>
</body>

</html>