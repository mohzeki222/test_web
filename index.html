<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Rhythm & Burst Prototype</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
            font-family: sans-serif;
        }

        /* 勢いを出すためにブラーを少し弱めて粒をはっきりさせる */
        canvas {
            display: block;
            filter: blur(8px) contrast(20);
            background-color: #000;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
            color: white;
            z-index: 10;
        }

        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
        }

        button {
            padding: 20px 40px;
            font-size: 24px;
            background: #ff0055;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
        }

        #score {
            font-size: 24px;
            color: #ff0055;
            font-weight: bold;
            text-shadow: 0 0 5px red;
        }

        .bar-container {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
        }

        #charge-bar {
            width: 0%;
            height: 100%;
            background: white;
            transition: width 0.1s;
        }

        /* 子宮口の演出 */
        #target-zone {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90px;
            height: 90px;
            border: 3px solid #660033;
            border-radius: 50%;
            background: radial-gradient(circle, transparent 30%, #440022 100%);
            opacity: 0.6;
        }
    </style>
</head>

<body>
    <div id="target-zone"></div>
    <div id="ui-layer">
        <div style="text-align:center;">
            <div id="score">COUNT: 0</div>
            <div id="status" style="font-size:12px; opacity:0.6;">Keep the Rhythm...</div>
        </div>
        <div style="margin-bottom: 50px;">
            <div class="bar-container">
                <div id="charge-bar"></div>
            </div>
        </div>
    </div>

    <div id="start-screen">
        <h1 style="color:white; margin-bottom:20px;">Rhythm & Burst</h1>
        <p style="color:#aaa; margin-bottom:30px;">リズムよく振って、タップで暴発</p>
        <button id="btn-start">START</button>
    </div>

    <script>
        // --- 物理パラメータ調整（ここを変えました） ---
        const FLUID_FRICTION = 0.8;      // 壁への張り付き（強め）
        const FLUID_AIR_FRICTION = 0.01; // 空気抵抗（かなり減らした＝初速が速い！）
        const FLUID_DENSITY = 0.08;      // 重さ（重くして衝撃を強く）

        // --- リズム調整 ---
        const RHYTHM_COOLDOWN = 300;     // 次のチャージまでの待機時間(ms) -> 早すぎると溜まらない

        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner,
            Bodies = Matter.Bodies, Composite = Matter.Composite, Mouse = Matter.Mouse,
            MouseConstraint = Matter.MouseConstraint, Events = Matter.Events;

        const engine = Engine.create();
        const world = engine.world;
        const width = window.innerWidth;
        const height = window.innerHeight;

        const render = Render.create({
            element: document.body, engine: engine,
            options: {
                width: width, height: height,
                wireframes: false, background: 'transparent',
                pixelRatio: window.devicePixelRatio
            }
        });

        // 壁（キャッチしやすいように摩擦最大）
        const wallOpt = { isStatic: true, render: { fillStyle: '#222' }, friction: 1.0 };
        const walls = [
            Bodies.rectangle(width / 2, height + 60, width, 100, wallOpt),
            Bodies.rectangle(0, height / 2, 30, height, wallOpt),
            Bodies.rectangle(width, height / 2, 30, height, wallOpt),
            Bodies.circle(width * 0.15, height * 0.25, 70, wallOpt), // 左の肉壁
            Bodies.circle(width * 0.85, height * 0.25, 70, wallOpt)  // 右の肉壁
        ];
        Composite.add(world, walls);

        // 変数
        let pleasure = 0;
        let particleCount = 0;
        let lastAcc = { x: 0, y: 0, z: 0 };
        let lastStrokeTime = 0; // リズム管理用

        // スタート
        document.getElementById('btn-start').addEventListener('click', async () => {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                try { await DeviceMotionEvent.requestPermission(); } catch (e) { }
            }
            window.addEventListener('devicemotion', handleMotion);
            document.getElementById('start-screen').style.display = 'none';
            Render.run(render);
            Runner.run(Runner.create(), engine);
        });

        // センサー処理（リズムロジック導入）
        function handleMotion(e) {
            const acc = e.accelerationIncludingGravity;
            if (!acc) return;

            const dy = Math.abs(acc.y - lastAcc.y);
            const dz = Math.abs(acc.z - lastAcc.z);

            // 一定以上の強さで振った時
            if (dy + dz > 12) {
                const now = Date.now();
                // 前回のチャージから一定時間経っていないと増えない（リズム制限）
                if (now - lastStrokeTime > RHYTHM_COOLDOWN) {
                    pleasure += 4; // 1回あたりの上昇量
                    if (pleasure > 100) pleasure = 100;

                    // ゲージ更新
                    document.getElementById('charge-bar').style.width = pleasure + '%';

                    // リズムエフェクト（ゲージが一瞬光るような処理の代わり）
                    // 気持ちゆっくり溜まる演出
                    lastStrokeTime = now;
                }
            }

            // 重力制御
            engine.gravity.x = acc.x * 0.2;
            engine.gravity.y = -acc.y * 0.2;

            lastAcc = { x: acc.x, y: acc.y, z: acc.z };
        }

        // 発射処理（暴発）
        // タップした瞬間に出る
        document.body.addEventListener('touchstart', (e) => {
            // 誤操作防止：画面下半分タップのみ反応
            if (e.touches[0].clientY > height * 0.4) {
                fireFluid();
            }
        });
        document.body.addEventListener('mousedown', () => { pleasure += 20; fireFluid(); });

        function fireFluid() {
            if (pleasure < 10) return;

            const amount = Math.floor(pleasure / 1.2); // 量は多め
            const startX = width / 2;
            const startY = height - 50;

            for (let i = 0; i < amount; i++) {
                const fluid = Bodies.circle(
                    startX + (Math.random() - 0.5) * 40,
                    startY + (Math.random() - 0.5) * 20,
                    4 + Math.random() * 6, // 粒の大きさ
                    {
                        render: { fillStyle: '#eee' }, // 少しグレーがかった白
                        friction: FLUID_FRICTION,         // 壁には張り付く
                        frictionAir: FLUID_AIR_FRICTION,  // 空気中では超高速
                        restitution: 0.1,
                        density: FLUID_DENSITY
                    }
                );

                // 発射力（前回より倍増させて勢いを出す）
                // 角度のブレも大きくして「暴発」感を出す
                const forceX = (Math.random() - 0.5) * 0.15;
                const forceY = -0.35 - (Math.random() * 0.3); // かなり強い上方向の力

                Matter.Body.applyForce(fluid, fluid.position, { x: forceX, y: forceY });
                Composite.add(world, fluid);
                particleCount++;
            }

            document.getElementById('score').innerText = "COUNT: " + particleCount;
            pleasure = 0;
            document.getElementById('charge-bar').style.width = '0%';
        }
    </script>
</body>

</html>